# Tips

The version of this program illustrated in the book is not working in modern linux systems. The main reason for this is that the structure of directory files has changed over time with the emergence of different file systems. More specifically, the authors used `read` to get a directory entry within `read_dir`. Apparently, this does not work on modern linux kernels due to different file systems and directory entry structures. In old Unix versions, directory entries were 16 bytes, using 2 bytes for the inode and 14 bytes for file names. Using `read` made sense, because the directory entries on the disk were all the *same size*, which is not the case in modern linux systems. Indeed, in modern linux, directory entries have different sizes.

To cope with this problem, one can use the `getdents` system call for implementing `read_dir`. The `getdents` system call returns *several* directory entries on each call, while the number of directory entries returned depends on the buffer size passed to it. If you set the `BUFSIZE` to 48, the current version provided here works for directories that do not have a directory entry of more than 48 bytes, which is the case for *most* of directories in this repository. This forces `getdents` to return *one* directory entry per call and somehow simulates the the old fixed sized directory entries. Alternatively, if you set the `BUFSIZE` to 1024, the current version only works for directories not having subdirectories. Indeed, one should implement an appropriate buffering for `Dir` like the one explained for `FILE` used in the `fopen` program to make this work. See also [this post][1] on stackoverflow.

[1]: https://stackoverflow.com/questions/77100299/implementing-a-simple-version-of-readdir-with-system-call